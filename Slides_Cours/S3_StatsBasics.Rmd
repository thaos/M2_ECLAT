---
title: "Séance 3"
subtitle: "Bases de statistique l'étude des aléas climatiques"
author: "Soulivanh Thao <br/> sthao@lsce.ipsl.fr"
institute: "LSCE, ESTIMR"
date: "2020/10/01 (updated: `r Sys.Date()`)"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---


# Séquence 2: Données et outils statistiques

- Séance 2: Pourquoi les statistiques pour étudier le climat? Avec quelles données ? + Séance pratique en R.

- Séance 3: Introduction aux notions statistiques de façon plus formelle

- Séance 4: Séances pratique en R sur les effets de l'aggrégation spatiale et l'effet de la variabilité interne sur les estimations statistiques.

- Séance 5: Introduction au downscaling statistique et correction de biais par la pratique.

Il y a beaucoup de pratique avec le logiciel R. Il vous faut donc l'installer ainsi que Rstudio.
Vous pouvez faire [ces exercices](https://github.com/thaos/MathDACC_tutoR/blob/master/Rtuto_basics/basics_tuto_exercices.R) pour vous familiariser avec R. La correction est disponible [ici](https://github.com/thaos/MathDACC_tutoR/blob/master/Rtuto_basics/basics_tuto.R.completed).

---
# Problèmes typiques

- Quelle température annuelle moyenne seront nous susceptible d'observer en 2051 ?
- Quelle est la probabilité que la température dépasse 290 K en 1950 ? en 2050 ?
- Quelle est la probabilité que la température dépasse 320 K en 1950 ? en 2050 ?
- Quelle seuil de température peut ont espérer dépasser au moins une fois tous les 50 ans ?

```{r, echo=FALSE, fig.height=4, dev='svg'}
tas_stagg <- readRDS(file = "../Ex2_aggregation/tas_stagg.rds")
tas <- readRDS(file = "../Ex2_aggregation/tas.rds")
dates <- dimnames(tas)[[3]]
years <- unique(as.integer(substring(dates, 1, 4)))

tas_smean_tmean <- tas_stagg[[1]][[1]]  

zones <- dimnames(tas_smean_tmean)[[2]]
periods <- dimnames(tas_smean_tmean)[[3]]
lon <- as.numeric(rownames(tas))
lat <- as.numeric(colnames(tas))

plot(
  years, tas_smean_tmean[, 1, 1], #* 3600 * 24 * 365,
  xlab = "year", ylab = "tas (K)", main = "tas, annual mean",
  pch = 20
  )
```

---
# Rappels sur les variables aléatoires continues


La distribution d'une variable aléatoire univariée et continue $X$ est entièrement déterminée par sa fonction de répartition (cumulative distribution function) 

$$F(x) = Pr (X \le x) $$
    
**Remarque** : on dit que $x_\alpha$ est le quantile de niveau $\alpha$ si $F(x_\alpha) = \alpha$
    
Si $F$ est une fonction continue, alors il existe une fonction positive $f$, appelé la densité de probabilité (probability density function) tel que

$$ Pr(a\le X\le b) = F(b) - F(a) = \int_a^b f(x)\,dx$$.


---
# cdf and pdf

```{r cdfpdf, echo=FALSE, fig.height=4, dev='svg'}
par(mfrow = c(1, 2))
x <- seq(-4, 4, by = 0.01)
plot(
  x, pnorm(x),
  main = "cdf", xlab = "x", ylab = "F(x)",
  type = "l", ylim = c(-0.1, 1)
)
abline(h = c(0, 1), lty = 2, col = "grey")
xstar <- -0.5
# xpol <- c(x[x < xstar], rep(xstar, 2))
# ypol <- c(pnorm(x[x < xstar]), pnorm(xstar), 0)
# polygon(xpol, ypol, col = "pink", border = NA)
# lines(x, pnorm(x))
segments(
  x0 = c(xstar, xstar),
  y0 = c(-1, pnorm(xstar)),
  x = c(xstar, -5),
  y = c(pnorm(xstar), pnorm(xstar)),
  lty = 2, col = "red"
)
text(
  x = c(-3.5, 0),
  y = c(0.35, -0.07),
  labels = c("F(a)", "a"),
  col = "red"
)

plot(
  x, dnorm(x),
  main = "pdf", xlab = "x", ylab = "f(x)",
  type = "l", ylim = c(-0.02, max(dnorm(x)))
)
abline(h = 0, lty = 2, col = "grey")
xstar <- -0.5
xpol <- c(-5, x[x < xstar], rep(xstar, 2))
ypol <- c(0, dnorm(x[x < xstar]), dnorm(xstar), 0)
polygon(xpol, ypol, col = "pink", border = NA)
lines(x, dnorm(x))
segments(
  x0 = xstar,
  y0 = -1,
  x = xstar,
  y = dnorm(xstar),
  lty = 2, col = "red"
)
text(
  x = c(-1.3, 0),
  y = c(0.02, -0.015),
  labels = c("F(a)", "a"),
  col = "red"
)
```

---
# Esperance
# Variance

# Estimateur

# Multivariate

dependence independance formule de bayes
vraisemblance


---
# Empirical estimator of the cdf

Soit $(X_1, ..., X_n)$ des variables aléatoires réelles, indépendantes et identiquement distribuées (i.i.d) ayant pour cdf $F$. On définit la fonction de répartition empirique (empirical cumulative distribution function) par 

$$\widehat F_n(x) =  \frac{1}{n} \sum_{i=1}^n \mathbf{1}_{X_i \le x}$$

```{r ecdf, echo=FALSE, fig.height=4, dev='svg'}
par(mfrow = c(1, 2))
x <- seq(-4, 4, by = 0.01)
plot(
  x, pnorm(x),
  main = "cdf", xlab = "x", ylab = "F(x)",
  type = "l", ylim = c(-0.1, 1)
)
abline(h = c(0, 1), lty = 2, col = "grey")
xstar <- -0.5
# xpol <- c(x[x < xstar], rep(xstar, 2))
# ypol <- c(pnorm(x[x < xstar]), pnorm(xstar), 0)
# polygon(xpol, ypol, col = "pink", border = NA)
# lines(x, pnorm(x))
segments(
  x0 = c(xstar, xstar),
  y0 = c(-1, pnorm(xstar)),
  x = c(xstar, -5),
  y = c(pnorm(xstar), pnorm(xstar)),
  lty = 2, col = "red"
)
text(
  x = c(-3.5, 0),
  y = c(0.35, -0.07),
  labels = c("F(a)", "a"),
  col = "red"
)

xsample <- rnorm(20)
plot(
  ecdf(xsample),
  main = "pdf", xlab = "x", ylab = "F(x)",
  ylim = c(-0.1, 1), xlim = c(-4, 4)
)
segments(
  x0 = c(xstar, xstar),
  y0 = c(-1, ecdf(xsample)(xstar)),
  x = c(xstar, -5),
  y = c(ecdf(xsample)(xstar), ecdf(xsample)(xstar)),
  lty = 2, col = "red"
)
text(
  x = c(-3.5, 0),
  y = c(ecdf(xsample)(xstar) + 0.05, -0.07),
  labels = c("F(a)", "a"),
  col = "red"
)
```

---
# Egalité en distribution

Deux variables aléatoires réelles X et Y sont égale en distribution si et seulement si elles ont la même fonction de répartition :
    
$$X \stackrel{d}{=} Y \Leftrightarrow \operatorname{P}(X \le x) = \operatorname{P}(Y \le x)\quad\text{for all }x$$
Pour comparer deux échantillons, on peut se baser sur les diagnostiques graphiques suivants :

```{r qqplot, echo=FALSE, fig.height=3, dev='svg'}
par(mfrow = c(1, 3))


xsample <- rnorm(20)
xsample2 <- rnorm(20, mean = 0.05, sd = 0.99)
xylim <- range(xsample, xsample2) + c(-0.3, 0.3)

plot(
  ecdf(xsample),
  main = "pdf", xlab = "x", ylab = "F(x)",
  xlim = xylim
)
lines(
  ecdf(xsample2), col = "brown"
)
legend(
  "bottomright", legend = c(expression('X'[1]), ylab = expression('X'[2])),
  pch = 20, col = c("black", "brown")
)
qqplot(
  xsample, xsample2,
  xlab = expression('X'[1]), ylab = expression('X'[2]),
  xlim = xylim, ylim = xylim,
  pch = 20, main = "qq-plot", asp = 1
)
abline(a = 0, b = 1, col = "red")
xmerged <- sort(c(xsample, xsample2))
xmerged <- xmerged[seq(1, length(xmerged), 1)]
# xmerged <- seq(min(xmerged), max(xmerged), length.out = 20)

plot(
  ecdf(xsample)(xmerged),
  ecdf(xsample2)(xmerged),
  xlab = expression('F'[X[1]]*'(x)'), ylab = expression('F'[X[2]]*'(x)'),
  xlim = c(0, 1), ylim = c(0, 1),
  pch = 20, main = "pp-plot", asp = 1
)
abline(a = 0, b = 1, col = "red")
```

---
# Convergence en loi et  fonction de répartition

Considérons:

- une suite $X_1$, $X_2$,  ..., $X_n$, de variables aléatoires réelles ayant respectivement pour fonction de répartition  $F_1$, $F_2$, ..., $F_n$ 

- et une autre variable aléatoire réelle $X$ de fonction de répartition $F$

On dit que $(X_n)_{n\ge 0}$ converge en loi vers $X$ si et seulement si 

$$\lim_{n \rightarrow \infty}\ F_n(x) = F(x)$$

dès que  la fonction de répartition $F$ de $X$ est continue en $x$, ou bien, de manière équivalente, dès que $\mathbb P(X=x)=0$ 

**Remark**.  Quand on utilise par exemple  la convergence en loi, on parle de théorie asymptotique.

---
# Théorème Central Limite.

Si $X_1,X_2,\ldots,X_n$ sont des variables aléatoires réelles indépendantes de même loi de probabilité, d'espérance $\mu$ et de variance $\sigma^2$ alors, lorsque $n$ est suffisamment grand :

la variable aléatoire :
$$ S_n = X_1+X_2+\ldots+X_n$$
suit approximativement une loi normale d'espérance $\mu \times n$ et d'écart-type $\sigma\sqrt n$, notée :
$$\mathcal N(\mu n,\sigma\sqrt n)$$

source : [wikiversity](https://fr.wikiversity.org/wiki/Th%C3%A9or%C3%A8me_central_limite)



---
# Théorème de la valeur extrême.

Soit $X_1,X_2\ldots, X_n\ldots$ une séquence de variables indépendantes et identiquement distribuées et $M_n=\max\{X_1,\ldots,X_n\}$. Si une séquence de paires de nombres réels $(a_n, b_n)$ existe telle que $a_n>0$ et
$$\lim_{n \to \infty}P\left(\frac{M_n-b_n}{a_n}\leq x\right) = F(x)$$,
où $F$ est une fonction de distribution non dégénérée, alors la distribution limite $F$ appartient à la famille des lois de Gumbel, lois de Fréchet, ou des lois de Weibull. Ces familles peuvent être regroupées dans la classe des lois d'extremum généralisées de fonction de répartition:

$$F(x;\mu,\sigma,\xi) = \exp\left\{-\left[1+\xi\left(\frac{x-\mu}{\sigma}\right)\right]_+^{-1/\xi}\right\}$$

avec
$\left(1+\xi(x-\mu)/\sigma \right)_+=\max\left( 0 , 1+\xi(x-\mu)/\sigma \right)$
où $\mu\in\mathbb{R}$ est un paramètre de position, $\sigma > 0$ un paramètre de dispersion et $\xi\in\mathbb{R}$ un paramètre de forme appelé ''indice des valeurs extrêmes''.


source : [wikipedia](https://fr.wikipedia.org/wiki/Th%C3%A9or%C3%A8me_de_Fisher-Tippett-Gnedenko)

---
# Loi d' extremum généralisée

Generalized Extreme Value distribution (GEV)
					
$$M_n = max\{X_1 , ... , X_n\},$$
où $X_l, ... , X_n$, est une séquence de variables aléatoires indépendantes et de fonction de répartition $F$.

**Theorem**
					
Si il existe  une séquence de constantes $\{a_n > 0\}$ et  $\{b_n\}$ tel que
$$\mathbb{P}\{(M_n - b_n)/a_n \leq z \} \rightarrow G(z) \text{ as } n \rightarrow \infty $$  

où  $G$ une fonction de répartition non-dégénérée, alors $G$ appartient à famille des distributions GEV

$$G(z) = \exp\left\{-\left[1 + \xi \left(\frac{z - \mu}{\sigma}\right)\right]^{-1/\xi}\right\},$$

définie sur $\{z : 1 + \xi (z - \mu) / \sigma \geq 0\}$, avec $-\infty < \mu < \infty$, $\sigma > 0$ et 	$-\infty < \xi < \infty$

---
# Loi d' extremum généralisée

**En pratique**, on ne cherche pas les constantes de normalisation  $\{a_n > 0\}$ et  $\{b_n\}$. On regarde simplement si les données sont cohérents avec une distribution GEV.


On utilise le fait que sous les hypothèse du théorème
$$\mathbb{P}\{M_n \leq z \} \approx G\{ (z - b_n)/a_n \} = G^*(z),$$
où $G^*$ est un autre membre de la famille des GEV.



---
# Loi de pareto genéralisée

Generalized Pareto Distribution (GPD)

$$(X - u) | (X > u) $$

where X has a distribution function $F$

**Theorem**
Si lorsque  $n \rightarrow \infty$, $M_n = max\{X_1 , ... , X_n\}$ converge en distribution vers $G$ appartenant à la famille GEV, alors pour $u$ assez grand,  la fonction de répartition de  $(X - u) | (X > u) $  peut être approximée par 

$$H(y) = 1 - \left(1 + \frac{\xi y}{\tilde{\sigma}} \right)^{-1/\xi}$$

définie sur $\{y : y > 0$ avec $(\xi y / \tilde{\sigma}) > 0 \}$




---
# Loi de pareto genéralisée

 **Remark**.  On a une correspondance avec les paramétrés da la distribution GEV
 
 - $\tilde{\sigma} =  \sigma + \xi (u - \mu)$  
 
 - le paramètre de forme est le même que celui de la GEV associée.
 
 - Le paramètre de forme  $\xi$, aussi appelé 'indice des valeurs extrêmes' charcterise le comportement de la queue de distribution: 
 
    - $\xi < 0$, la  distribution a une borne supérieure égale à $\mu - \tilde{\sigma} / \xi$ 
    - $\xi = 0$, la distribution a une queue à décroissance exponentielle. On interprète ce cas comme la limite de $\lim_{\xi \rightarrow 0} H(y)$
    - $\xi > 0$, la distribution est à queue lourde. 


